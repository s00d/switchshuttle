<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Config Editor</title>
    <style>
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            box-sizing: border-box;
        }

        body {

        }

        .container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 40px;
            text-align: center;
            width: 100%;
            position: relative;
            height: auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow-x: scroll;
        }

        .title-bar {
            width: 100%;
            height: 22px;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box;
            -webkit-app-region: drag;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2;
        }

        .title-bar .buttons {
            display: flex;
            gap: 8px;
        }

        .title-bar .buttons div {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ff5f56;
            cursor: pointer;
            -webkit-app-region: no-drag;
        }

        .title-bar .buttons div:nth-child(2) {
            background-color: #ffbd2e;
        }

        .title-bar .buttons div:nth-child(3) {
            background-color: #27c93f;
        }

        .title-bar .title {
            flex-grow: 1;
            text-align: center;
            font-size: 12px;
            color: #555;
            -webkit-app-region: drag;
            padding-left: 22px;
        }

        h1 {
            margin-top: 40px;
            font-size: 24px;
            color: #333;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
        }

        .form-group label {
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
            width: 80%;
            text-align: left;
        }

        .form-group input, .form-group select {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: #007aff;
            box-shadow: 0 0 3px 2px rgba(0, 123, 255, 0.25);
            outline: none;
        }

        .buttons {
            display: flex;
            justify-content: center;
            margin-top: 2px;
        }

        button {
            padding: 6px 20px;
            font-size: 14px;
            border: 1px solid #ccd0d5;
            border-radius: 6px;
            background: linear-gradient(to bottom, #ffffff, #e0e0e0);
            color: #333;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin: 10px 5px;
        }

        button:hover {
            background: linear-gradient(to bottom, #e0e0e0, #d0d0d0);
            border-color: #bbb;
        }

        button:active {
            background: linear-gradient(to bottom, #d0d0d0, #c0c0c0);
            border-color: #aaa;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        button:focus {
            outline: none;
            box-shadow: 0 0 3px 2px rgba(0, 123, 255, 0.25);
        }

        .cancel-button {
            background: linear-gradient(to bottom, #dc3545, #c82333);
            color: white;
        }

        .cancel-button:hover {
            background: linear-gradient(to bottom, #c82333, #a71d2a);
            border-color: #a71d2a;
        }

        .cancel-button:active {
            background: linear-gradient(to bottom, #a71d2a, #8a1621);
            border-color: #8a1621;
        }

        .button-blue {
            border: 1px solid #007aff;
            background: linear-gradient(to bottom, #007aff, #005bb5);
            color: white;
        }

        .button-blue:hover {
            background: linear-gradient(to bottom, #005bb5, #004a99);
            border-color: #005bb5;
        }

        .button-blue:active {
            background: linear-gradient(to bottom, #004a99, #003d7a);
            border-color: #004a99;
        }

        .d-flex {
            display: flex;
            width: 100%;
            justify-content: center;
        }

        .gap-2 {
            gap: 8px;
        }

        .form-control {
            width: calc(100% - 20px);
            margin: 0 10px;
        }

        #notification {
            width: 80%;
            margin: 20px auto;
            padding: 10px;
            border-radius: 6px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: left;
        }

        th {
            background: #f0f0f5;
        }

        .modal {
            display: block;
            background: rgba(0, 0, 0, 0.5);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-items: center;
            z-index: 3;
        }

        .modal-dialog {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 80%;
            max-width: 400px;
            margin: auto;
            margin-top: 50px;
        }

        .modal-header, .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .modal-footer {
            border-top: 1px solid #e0e0e0;
            padding-top: 10px;
            margin-top: 20px;
        }

        .modal-title {
            font-size: 18px;
            color: #333;
        }

        .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }

        .nested-table {
            margin-left: 5px;
        }
    </style>
</head>
<body>

<div id="app">
    <div data-tauri-drag-region class="title-bar">
        <div data-tauri-drag-region class="title">Config Editor</div>
        <div class="buttons">
            <div onclick="cancel()"></div>
        </div>
    </div>
    <div  class="container">
        <h1>Config Editor</h1>

        <div id="notification" :class="notificationClass" class="alert" v-if="notificationMessage" v-text="notificationMessage"></div>

        <div class="form-group">
            <label for="config-select">Select Config</label>
            <div class="d-flex gap-2">
                <select id="config-select" class="form-control" v-model="currentConfig" @change="loadConfig">
                    <option v-for="file in configFiles" :value="file.path" :key="file.path" v-text="file.name"></option>
                </select>
                <button class="button-blue" @click="showAddConfigModal">+</button>
                <button class="cancel-button" @click="showDeleteConfigModal">x</button>
            </div>
        </div>

        <div class="form-group">
            <label for="menu-title">Menu Title</label>
            <input type="text" id="menu-title" class="form-control" v-model="config.menu_title">
        </div>

        <div class="form-group">
            <label for="terminal">Terminal</label>
            <select id="terminal" class="form-control" v-model="config.terminal">
                <option value="iterm">iTerm</option>
                <option value="terminal">Terminal</option>
                <option value="warp">Warp</option>
            </select>
        </div>

        <div class="form-group">
            <label for="launch-in">Launch In</label>
            <select id="launch-in" class="form-control" v-model="config.launch_in">
                <option value="current">Current</option>
                <option value="new_tab">New Tab</option>
                <option value="new_window">New Window</option>
            </select>
        </div>

        <div class="form-group">
            <label for="theme">Theme</label>
            <input type="text" id="theme" class="form-control" v-model="config.theme">
        </div>

        <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" class="form-control" v-model="config.title">
        </div>

        <div class="form-group">
            <label for="menu-hotkey">Menu Hotkey</label>
            <input type="text" id="menu-hotkey" class="form-control" v-model="config.menu_hotkey" @keydown="hotkeyHandlerMenu">
        </div>

        <table id="commands-table">
            <thead>
            <tr>
                <th>Command Name</th>
                <th>Single Command</th>
                <th>Commands</th>
                <th>Hotkey</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <template v-for="(command, index) in config.commands">
                <tr :key="index" :data-index="index">
                    <td><input type="text" class="form-control" v-model="command.name"></td>
                    <td><input v-if="!command.submenu" type="text" class="form-control" v-model="command.command" :disabled="command.commands && command.commands.length"></td>
                    <td>
                        <div v-if="!command.submenu" v-for="(cmd, cmdIndex) in command.commands" :key="cmdIndex" class="d-flex align-items-center">
                            <input type="text" class="form-control" v-model="command.commands[cmdIndex]">
                            <button class="cancel-button" @click="deleteInnerCommand(index, cmdIndex)">Delete</button>
                        </div>
                        <button v-if="!command.submenu" class="button-blue" @click="addInnerCommand(index)">+</button>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <input type="checkbox" class="mr-2" :checked="command.hotkey !== null" @change="toggleHotkeyInput(index, command.hotkey)">
                            <input type="text" class="form-control" v-model="command.hotkey" v-if="command.hotkey !== null" @keydown="hotkeyHandler($event, index)" :disabled="command.submenu">
                        </div>
                    </td>
                    <td>
                        <button class="button-blue" @click="addSubCommand(index)">+</button>
                        <button class="cancel-button" @click="deleteCommand(index)">x</button>
                    </td>
                </tr>
                <tr v-if="command.submenu" :key="'sub' + index">
                    <td colspan="5">
                        <table class="nested-table">
                            <thead>
                            <tr>
                                <th>Subcommand Name</th>
                                <th>Single Command</th>
                                <th>Commands</th>
                                <th>Hotkey</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <template v-for="(subCommand, subIndex) in command.submenu">
                                <tr :key="'sub' + subIndex" :data-index="subIndex">
                                    <td><input type="text" class="form-control" v-model="subCommand.name"></td>
                                    <td><input type="text" class="form-control" v-model="subCommand.command" :disabled="subCommand.commands && subCommand.commands.length"></td>
                                    <td>
                                        <div v-if="!command.submenu" v-for="(cmd, cmdIndex) in subCommand.commands" :key="cmdIndex" class="d-flex align-items-center">
                                            <input type="text" class="form-control" v-model="subCommand.commands[cmdIndex]">
                                            <button class="cancel-button" @click="deleteInnerSubCommand(index, subIndex, cmdIndex)">Delete</button>
                                        </div>
                                        <button v-if="!command.submenu" class="button-blue" @click="addInnerSubCommand(index, subIndex)">+</button>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <input type="checkbox" class="mr-2" :checked="subCommand.hotkey !== null" @change="toggleHotkeyInput(index, subIndex, true)">
                                            <input type="text" class="form-control" v-model="subCommand.hotkey" v-if="subCommand.hotkey !== null" @keydown="hotkeyHandler($event, index, subIndex)">
                                        </div>
                                    </td>
                                    <td>
                                        <button class="button-blue" @click="addSubCommand(index, subIndex)">+</button>
                                        <button class="cancel-button" @click="deleteSubCommand(index, subIndex)">x</button>
                                    </td>
                                </tr>
                            </template>
                            </tbody>
                        </table>
                    </td>
                </tr>
            </template>
            </tbody>
        </table>
        <div class="table-actions text-center">
            <button class="button-blue" @click="addCommand">Add Command</button>
        </div>

        <div class="button-group d-flex justify-content-between mt-4">
            <button class="button-blue" @click="saveConfig">Save</button>
            <button class="cancel-button" @click="cancel">Cancel</button>
        </div>

        <div id="add-config-modal" v-if="addConfigModal" class="modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Config</h5>
                        <button type="button" class="close" @click="closeAddConfigModal">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="new-config-name">Config Name</label>
                            <input type="text" id="new-config-name" class="form-control" v-model="newConfigName">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="button-blue" @click="addNewConfig">Add</button>
                        <button type="button" class="cancel-button" @click="closeAddConfigModal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="delete-config-modal" v-if="deleteConfigModal" class="modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirm Delete</h5>
                        <button type="button" class="close" @click="closeDeleteConfigModal">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this config?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-button" @click="deleteConfig">Delete</button>
                        <button type="button" class="button-blue" @click="closeDeleteConfigModal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="assets/vue2.js"></script>
<script>
    const { listen } = window.__TAURI__.event;
    const { writeTextFile, readTextFile, exists, readDir, removeFile } = window.__TAURI__.fs;
    const path = window.__TAURI__.path;
    const appWindow = window.__TAURI__.window;

    new Vue({
        el: '#app',
        data: {
            configFiles: [],
            currentConfig: '',
            config: {
                menu_title: '',
                terminal: 'iterm',
                launch_in: 'current',
                theme: '',
                title: '',
                commands: [],
                menu_hotkey: ''
            },
            newConfigName: '',
            notificationMessage: '',
            notificationClass: '',
            addConfigModal: false,
            deleteConfigModal: false
        },
        methods: {
            async loadConfigs() {
                const configDir = await path.configDir();
                const configFiles = await readDir(configDir + '/switch-shuttle');
                this.configFiles = configFiles.filter(file => file.name.endsWith('.json')).map(file => ({ path: file.path, name: file.name.replace('.json', '') }));
                if (this.configFiles.length > 0) {
                    this.currentConfig = this.configFiles[0].path;
                    this.loadConfig();
                }
            },
            async loadConfig() {
                if (await exists(this.currentConfig)) {
                    const configContent = await readTextFile(this.currentConfig);
                    this.config = JSON.parse(configContent);
                }
            },
            async saveConfig() {
                try {
                    await writeTextFile(this.currentConfig, JSON.stringify(this.config, null, 2));
                    this.showNotification('Config saved successfully', 'success');
                    this.cancel();
                } catch (error) {
                    this.showNotification('Failed to save config', 'error');
                }
            },
            addCommand() {
                this.config.commands.push({ name: '', command: '', hotkey: '', hotkeyEnabled: false, submenu: [], commands: [] });
            },
            deleteCommand(index) {
                this.config.commands.splice(index, 1);
            },
            addInnerCommand(index) {
                this.config.commands[index].commands = this.config.commands[index].commands || [];
                this.config.commands[index].commands.push('');
            },
            deleteInnerCommand(index, cmdIndex) {
                this.config.commands[index].commands.splice(cmdIndex, 1);
            },
            addSubCommand(index, subIndex = null) {
                if (subIndex === null) {
                    this.config.commands[index].submenu = this.config.commands[index].submenu || [];
                    this.config.commands[index].submenu.push({ name: '', command: '', hotkey: '', submenu: [], commands: [] });
                } else {
                    this.config.commands[index].submenu[subIndex].submenu = this.config.commands[index].submenu[subIndex].submenu || [];
                    this.config.commands[index].submenu[subIndex].submenu.push({ name: '', command: '', hotkey: '', submenu: [], commands: [] });
                }
            },
            deleteSubCommand(index, subIndex) {
                this.config.commands[index].submenu.splice(subIndex, 1);
            },
            addInnerSubCommand(index, subIndex) {
                this.config.commands[index].submenu[subIndex].commands = this.config.commands[index].submenu[subIndex].commands || [];
                this.config.commands[index].submenu[subIndex].commands.push('');
            },
            deleteInnerSubCommand(index, subIndex, cmdIndex) {
                this.config.commands[index].submenu[subIndex].commands.splice(cmdIndex, 1);
            },
            toggleHotkeyInput(index, isEnabled, isSub = false, subIndex = null) {
                if (isSub) {
                    const subCommand = this.config.commands[index].submenu[subIndex];
                    subCommand.hotkey = subCommand.hotkey ? null : '';
                } else {
                    const command = this.config.commands[index];
                    command.hotkey = command.hotkey ? null : '';
                }
            },
            hotkeyHandler(event, index, subIndex = null) {
                event.preventDefault();
                let hotkey = [];
                if (event.ctrlKey) hotkey.push('Ctrl');
                if (event.shiftKey) hotkey.push('Shift');
                if (event.altKey) hotkey.push('Alt');
                if (event.metaKey) hotkey.push('Command');
                if (event.key && !['Control', 'Shift', 'Alt', 'Meta'].includes(event.key)) hotkey.push(event.key);

                if (subIndex !== null) {
                    this.config.commands[index].submenu[subIndex].hotkey = hotkey.join('+');
                } else {
                    this.config.commands[index].hotkey = hotkey.join('+');
                }
            },
            hotkeyHandlerMenu(event) {
                event.preventDefault();
                let hotkey = [];
                if (event.ctrlKey) hotkey.push('Ctrl');
                if (event.shiftKey) hotkey.push('Shift');
                if (event.altKey) hotkey.push('Alt');
                if (event.metaKey) hotkey.push('Command');
                if (event.key && !['Control', 'Shift', 'Alt', 'Meta'].includes(event.key)) hotkey.push(event.key);
                this.config.menu_hotkey = hotkey.join('+');
            },
            showNotification(message, type) {
                this.notificationMessage = message;
                this.notificationClass = `alert-${type}`;
                setTimeout(() => {
                    this.notificationMessage = '';
                    this.notificationClass = '';
                }, 3000);
            },
            showAddConfigModal() {
                this.addConfigModal = true;
            },
            closeAddConfigModal() {
                this.addConfigModal = false;
            },
            showDeleteConfigModal() {
                this.deleteConfigModal = true;
            },
            closeDeleteConfigModal() {
                this.deleteConfigModal = false;
            },
            async addNewConfig() {
                if (!this.newConfigName) {
                    this.showNotification('Config name cannot be empty', 'error');
                    return;
                }
                const configDir = await path.configDir();
                const newConfigPath = `${configDir}/switch-shuttle/${this.newConfigName}.json`;
                const defaultConfig = {
                    menu_title: "Commands",
                    terminal: "iterm",
                    launch_in: "current",
                    theme: "Homebrew",
                    title: "New tab",
                    commands: [],
                    menu_hotkey: ''
                };
                try {
                    await writeTextFile(newConfigPath, JSON.stringify(defaultConfig, null, 2));
                    this.showNotification('New config added successfully', 'success');
                    this.closeAddConfigModal();
                    this.loadConfigs();
                } catch (error) {
                    this.showNotification('Failed to add new config', 'error');
                }
            },
            async deleteConfig() {
                if (!this.currentConfig) {
                    this.showNotification('No config selected to delete', 'error');
                    return;
                }
                try {
                    await removeFile(this.currentConfig);
                    this.showNotification('Config deleted successfully', 'success');
                    this.closeDeleteConfigModal();
                    this.loadConfigs();
                } catch (error) {
                    this.showNotification('Failed to delete config', 'error');
                }
            },
            cancel() {
                appWindow.getCurrent().close();
            }
        },
        mounted() {
            this.loadConfigs();
        }
    });
</script>
</body>
</html>
